var oes=oes||{};oes.ui=oes.ui||{},oes.ui.space=oes.ui.space||{},oes.ui.space.grid={i:{},o:{objectViews:{}},gridCellSize:3,gridCellValueColors:["white","blue","red","green","brown","grey"]},oes.ui.space.grid.setup=function(e){var o=sim.model.space.xMax,i=sim.model.space.yMax,r=null,s=0,t=0,n=0,c=dom.createElement("table",{id:"visCanvas"}),l=document.createElement("style");for(sim.config.observationUI&&sim.config.observationUI.spaceView&&(n=sim.config.observationUI.spaceView.gridCellSize),n=n||oes.ui.space.grid.gridCellSize,"function"==typeof n&&(n=parseInt(n())),oes.ui.space.grid.gridCellSize=parseInt(n),l.innerHTML="table#visCanvas td {width:"+n+"px; height:"+n+"px; font-size:"+(n-4)+"px; line-height:"+n+"px;}",document.head.appendChild(l),e?e.appendChild(c):document.body.appendChild(c),sim.visualEl=c,s=0;s<i;s++)for(r=c.insertRow(),t=0;t<o;t++)r.insertCell()},oes.ui.space.grid.reset=function(){var e=sim.model.space.xMax,o=sim.model.space.yMax,i=null,r=0,s=0;for(sim.visualEl.innerHTML="",r=0;r<o;r++)for(i=sim.visualEl.insertRow(),s=0;s<e;s++)i.insertCell()},oes.ui.space.grid.i.dom={},oes.ui.space.grid.i.dom.renderIntegerGrid=function(){var e=0,o=0,i=0,r=sim.model.space.xMax,s=sim.model.space.yMax,t=null,n=sim.visualEl.rows,c=sim.config.observationUI.gridCellValueColors||oes.ui.space.grid.gridCellValueColors;for(e=0;e<s;e++)for(t=n[e].cells,o=0;o<r;o++)i=15&sim.space.grid[(s-e-1)*r+o],i>0?t[o].style.backgroundColor=c[i]:t[o].removeAttribute("style"),(i=(240&sim.space.grid[(s-e-1)*r+o])/16)>0&&(t[o].textContent=String(i))},oes.ui.space.grid.o.dom={getGridCellColor:function(){}},oes.ui.space.grid.o.dom.setupObjectGrid=function(){var e=null,o=0,i=0,r=sim.model.space.xMax,s=sim.model.space.yMax,t=null,n=null,c=null;if(oes.ui.space.grid.setup(),oes.ui.space.grid.o.dom.getGridCellColor=oes.ui.space.grid.o.dom.processColor(sim.config.observationUI.spaceView.gridCellColor),sim.config.observationUI&&(e=sim.config.observationUI,e.objectViews,oes.ui.space.grid.o.dom.createObjectViews(),e.spaceView&&e.spaceView.showGridCellInfoOnFlyOver||(oes.ui.space.grid.o.dom.showGridCellsInfoOnFlyOver=function(){}),sim.config.observationUI.spaceView.showGridCellInfoOnFlyOver))for(n=function(e,o){return function(){var i=sim.space.grid[e][o],r=sim.visualEl.rows[o].cells[e],s=r.getAttribute("data-objectId");r.title=s?oes.ui.space.grid.o.dom.getFlyOverInfoForObject(sim.objects[s]):oes.ui.space.grid.o.dom.getFlyOverInfoForGridCell(i)}},c=function(e,o){return function(){sim.space.grid[e][o];sim.visualEl.rows[o].cells[e].removeAttribute("title")}},o=0;o<s;o++)for(i=0;i<r;i++)t=sim.visualEl.rows[o].cells[i],t.addEventListener("mouseenter",n(i,o)),t.addEventListener("mouseout",c(i,o))},oes.ui.space.grid.o.dom.renderObjectGrid=function(){var e=0,o=0,i=sim.model.space.xMax,r=sim.model.space.yMax,s=null,t=null,n=null,c=sim.visualEl.rows,l="";for(e=0;e<r;e++)for(s=c[e].cells,o=0;o<i;o++)t=sim.space.grid[o][e],n=s[o],l=oes.ui.space.grid.o.dom.getGridCellColor(t),l?n.style.backgroundColor=l:n.removeAttribute("style");oes.ui.space.grid.o.dom.renderObjects()},oes.ui.space.grid.o.dom.processColor=function(e){var o=0,i=[],r=[],s=0;if(!e)return function(){return"rgb(191, 191, 191)"};if("string"==typeof e)return function(){return e};if("function"==typeof e)return function(o){return e(o)};for(r[0]=e.H||e.R||0,r[1]=e.S||e.G||0,r[2]=e.L||e.B||0,r[3]=i[3]=e.A||1,o=e.A||0===e.A?4:3,s=0;s<o;s++)"function"==typeof r[s]?i[s]=function(e){return function(o){return 3===e?r[e](o):parseInt(r[e](o))}}(s):"string"==typeof r[s]?i[s]=function(e){return function(o){return 3===e?o[r[e]]:parseInt(o[r[e]])}}(s):Array.isArray(r[s])?i[s]=function(e){var o=r[e][0],i=r[e][1];return function(r){return void 0!==r[o]&&"function"==typeof i?3===e?i(r[o],r):parseInt(i(r[o],r)):0}}(s):"number"==typeof r[s]?i[s]=function(e){return function(){return 3===e?r[e]:parseInt(r[e])}}(s):console.log("oes.ui.space.grid.o.dom.processColor: Unsuported color computation method.",e,r[s]);return void 0!==e.H&&void 0!==e.S&&void 0!==e.L?function(e){return"hsl("+i[0](e)+","+i[1](e)+"%,"+i[2](e)+"%)"}:void 0!==e.R&&void 0!==e.G&&void 0!==e.B?("function"!=typeof i[3]&&(i[3]=function(){return 1}),function(e){return"rgba("+i[0](e)+","+i[1](e)+","+i[2](e)+","+i[3](e)+")"}):function(){return"rgb(191, 191, 191)"}},oes.ui.space.grid.o.dom.getFlyOverInfoForGridCell=function(e){var o="";return Object.keys(e).forEach(function(i){"objects"!==i&&(o+=i+": "+e[i]+"\n")}),o},oes.ui.space.grid.o.dom.createObjectViews=function(){var e=null;sim.config.observationUI&&sim.config.observationUI.objectViews&&(e=sim.config.observationUI.objectViews,Object.keys(sim.objects).forEach(function(o){var i=sim.objects[o],r=e[o]||e[i.constructor.Name];r&&(oes.ui.space.grid.o.objectViews[String(i.id)]=oes.ui.space.grid.o.dom.createObjectView(i,r,sim.model.space.gridCellMaxOccupancy))}))},oes.ui.space.grid.o.dom.createObjectView=function(e,o,i){var r=o.content||"",s=oes.ui.space.grid.o.dom.processColor,t=null,n=null,c=sim.model.space.yMax,l=sim.visualEl.rows,u=l[c-e.pos[1]].cells[e.pos[0]-1],a=null,d={};return"function"==typeof r&&(r=r(e)),1===i?(a=u,a.innerHTML=r):(a=dom.createElement("div",{content:r,classValues:"object-view"}),u.appendChild(a)),a.setAttribute("data-objectId",e.id),o.backgroundColor&&(t=s(o.backgroundColor)),o.color&&(n=s(o.color)),parseInt(o.roundedCorners)>0&&(a.style.borderRadius=o.roundedCorners),d.domEl=a,d.computeBackgroundColor=t,d.computeColor=n,o.showObjectInfoOnFlyOver&&(a.addEventListener("mouseenter",function(){var e=sim.objects[a.getAttribute("data-objectId")];e&&(d.showFlyOverInfo=!0,a.title=oes.ui.space.grid.o.dom.getFlyOverInfoForObject(e))}),a.addEventListener("mouseout",function(){d.showFlyOverInfo=!1,a.removeAttribute("title")})),d},oes.ui.space.grid.o.dom.getFlyOverInfoForObject=function(e){var o="type: "+e.constructor.Name+"\n";return Object.keys(e).forEach(function(i){o+=i+": "+e[i]+"\n"}),o},oes.ui.space.grid.o.dom.renderObjects=function(){var e=oes.ui.space.grid.o.objectViews,o=sim.objects,i=oes.ui.space.grid.o.dom.getFlyOverInfoForObject;Object.keys(oes.ui.space.grid.o.objectViews).forEach(function(r){var s=e[r],t=o[r];s.domEl.style.backgroundColor=s.computeBackgroundColor(t),s.domEl.style.color=s.computeColor(t),s.showFlyOverInfo&&(s.domEl.title=i(t))})};